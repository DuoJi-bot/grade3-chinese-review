<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ­æ–‡ç¤ºä¾‹ - ä¸‰å¹´çº§è¯­æ–‡å¤ä¹ </title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        .text-card {
            padding: 1.5rem;
        }

        .text-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
            text-align: center;
        }

        .text-content {
            padding: 1.5rem;
            background: var(--bg-color);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            line-height: 2;
            color: var(--text-primary);
            text-indent: 2em;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .text-content:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .text-content.speaking {
            background: rgba(99, 102, 241, 0.1);
            border-left: 4px solid var(--primary-color);
        }

        .example-list {
            margin-top: 1rem;
        }

        .example-item {
            padding: 1rem;
            background: var(--bg-color);
            border-radius: var(--radius-lg);
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .example-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .example-item.speaking {
            background: rgba(99, 102, 241, 0.1);
            border-left: 4px solid var(--primary-color);
        }

        .example-topic {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .example-text {
            font-size: 0.9rem;
            line-height: 1.8;
            color: var(--text-primary);
        }

        .section-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .section-tab {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .section-tab:hover,
        .section-tab.active {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }

        .hint-text {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-top: 1rem;
        }
    </style>
</head>

<body>
    <div class="quiz-container">
        <header class="quiz-header">
            <div class="quiz-back-btn" id="backBtn">
                <span>â†</span>
                <span>è¿”å›</span>
            </div>
            <h1 class="quiz-title" id="quizTitle">çŸ­æ–‡ç¤ºä¾‹</h1>
            <div class="quiz-progress" id="progressText">ç‚¹å‡»æœ—è¯»</div>
        </header>

        <div class="quiz-content" id="quizContent">
            <div class="loading">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <div class="nav-buttons">
            <button class="btn btn-outline" id="prevBtn">â† ä¸Šä¸€ä¸ª</button>
            <button class="btn btn-primary" id="speakBtn">ğŸ”Š æœ—è¯»å…¨æ–‡</button>
            <button class="btn btn-outline" id="nextBtn">ä¸‹ä¸€ä¸ª â†’</button>
        </div>
    </div>

    <script src="../js/utils/tts.js"></script>
    <script src="../js/utils/storage.js"></script>
    <script src="../js/quiz-types/QuizBase.js"></script>
    <script>
        class TextMemoryQuiz extends QuizBase {
            constructor(options) {
                super(options);
                this.sections = [];
                this.currentSectionIndex = 0;
            }

            async loadData() {
                const dataKey = this.getUrlParam('data') || 'writing_exercises';
                const data = await this.fetchJson('../data/text_examples.json');

                const section = data.sections.find(s => s.id === dataKey);
                if (section) {
                    document.getElementById('quizTitle').textContent = section.title;
                    this.questions = section.items;
                }
            }

            // è¦†ç›–åˆå§‹åŒ–æ–¹æ³•ï¼Œç¡®ä¿å¯¼èˆªæŒ‰é’®äº‹ä»¶åªç»‘å®šä¸€æ¬¡
            async init() {
                try {
                    await this.loadData();
                    this.render();
                    this.bindNavigationEvents(); // åªåœ¨åˆå§‹åŒ–æ—¶ç»‘å®šä¸€æ¬¡å¯¼èˆªæŒ‰é’®äº‹ä»¶
                    this.updateProgress();
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                    this.showError('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
            }

            render() {
                const item = this.questions[this.currentIndex];

                let html = `
                    <div class="section-tabs">
                        ${this.questions.map((q, i) => `
                            <button class="section-tab ${i === this.currentIndex ? 'active' : ''}" data-index="${i}">${q.title.slice(0, 10)}...</button>
                        `).join('')}
                    </div>

                    <div class="text-card">
                        <h3 class="text-title">${item.title}</h3>
                `;

                if (item.examples) {
                    html += `<div class="example-list">`;
                    item.examples.forEach((ex, i) => {
                        const topic = ex.topic || ex.starter || ex.location || `ç¤ºä¾‹${i + 1}`;
                        const text = ex.text;
                        html += `
                            <div class="example-item" data-text="${text.replace(/"/g, '&quot;')}" data-index="${i}">
                                <div class="example-topic">${topic}</div>
                                <div class="example-text">${text}</div>
                            </div>
                        `;
                    });
                    html += `</div>`;
                } else if (item.text) {
                    html += `<div class="text-content" data-text="${item.text.replace(/"/g, '&quot;')}">${item.text}</div>`;
                }

                html += `
                        <p class="hint-text">ğŸ’¡ ç‚¹å‡»æ–‡æœ¬å¯ä»¥æœ—è¯»</p>
                    </div>
                `;

                this.container.innerHTML = html;
                this.bindEvents();
                this.updateNavButtons();
                this.updateProgress();
            }

            bindEvents() {
                // ç‚¹å‡»æœ—è¯»
                const textContents = this.container.querySelectorAll('.text-content, .example-item');
                textContents.forEach(el => {
                    el.addEventListener('click', () => {
                        textContents.forEach(e => e.classList.remove('speaking'));
                        el.classList.add('speaking');

                        const text = el.dataset.text || el.textContent;
                        this.speak(text, {
                            onEnd: () => {
                                el.classList.remove('speaking');
                            }
                        });
                    });
                });

                // åˆ‡æ¢æ ‡ç­¾
                const tabs = this.container.querySelectorAll('.section-tab');
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.currentIndex = parseInt(tab.dataset.index);
                        this.render();
                    });
                });
            }

            // ç»‘å®šå›ºå®šå¯¼èˆªæŒ‰é’®çš„äº‹ä»¶ï¼ˆåªè°ƒç”¨ä¸€æ¬¡ï¼‰
            bindNavigationEvents() {
                document.getElementById('prevBtn').addEventListener('click', () => this.prevQuestion());
                document.getElementById('nextBtn').addEventListener('click', () => this.nextQuestion());
                document.getElementById('backBtn').addEventListener('click', () => this.goBack());

                document.getElementById('speakBtn').addEventListener('click', () => {
                    const item = this.questions[this.currentIndex];
                    if (item.examples) {
                        const allText = item.examples.map(e => e.text).join('ã€‚');
                        this.speak(allText);
                    } else if (item.text) {
                        this.speak(item.text);
                    }
                });
            }

            updateNavButtons() {
                document.getElementById('prevBtn').disabled = this.currentIndex === 0;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const quiz = new TextMemoryQuiz({
                moduleId: new URLSearchParams(window.location.search).get('id') || 'text-memory'
            });
            quiz.init();
        });
    </script>
</body>

</html>