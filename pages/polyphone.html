<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šéŸ³å­—è¾¨æ - ä¸‰å¹´çº§è¯­æ–‡å¤ä¹ </title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        .polyphone-card {
            text-align: center;
            padding: 2rem;
        }

        .main-character {
            font-size: 5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .question-text {
            font-size: 1.125rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .readings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .reading-option {
            padding: 1.5rem;
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .reading-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .reading-option.selected {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }

        .reading-option.correct {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.1);
        }

        .reading-option.wrong {
            border-color: var(--error-color);
            background: rgba(239, 68, 68, 0.1);
        }

        .reading-pinyin {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .reading-words {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            opacity: 0;
            height: 0;
            overflow: hidden;
            transition: all var(--transition-normal);
        }

        .reading-words.show {
            opacity: 1;
            height: auto;
            margin-top: 0.5rem;
        }

        .reading-word {
            padding: 0.25rem 0.75rem;
            background: var(--card-bg);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .word-sentence {
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--bg-color);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            color: var(--text-primary);
            line-height: 1.8;
        }

        .word-sentence .highlight {
            color: var(--primary-color);
            font-weight: 600;
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="quiz-container">
        <header class="quiz-header">
            <div class="quiz-back-btn" id="backBtn">
                <span>â†</span>
                <span>è¿”å›</span>
            </div>
            <h1 class="quiz-title">å¤šéŸ³å­—è¾¨æ</h1>
            <div class="quiz-progress" id="progressText">- / -</div>
        </header>

        <div class="progress-bar">
            <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
        </div>

        <div class="quiz-content" id="quizContent">
            <div class="loading">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <div class="nav-buttons">
            <button class="btn btn-outline" id="prevBtn">â† ä¸Šä¸€é¢˜</button>
            <button class="btn btn-primary" id="speakBtn">ğŸ”Š æœ—è¯»</button>
            <button class="btn btn-outline" id="nextBtn">ä¸‹ä¸€é¢˜ â†’</button>
        </div>
    </div>

    <script src="../js/utils/tts.js"></script>
    <script src="../js/utils/storage.js"></script>
    <script src="../js/quiz-types/QuizBase.js"></script>
    <script>
        class PolyphoneQuiz extends QuizBase {
            constructor(options) {
                super(options);
                this.answered = false;
                this.currentQuestion = null;
            }

            async loadData() {
                const data = await this.fetchJson('../data/polyphones.json');

                // ä¸ºæ¯ä¸ªå¤šéŸ³å­—ç”Ÿæˆä¸€é“é¢˜ï¼ˆéšæœºé€‰æ‹©å…¶ä¸­ä¸€ä¸ªè¯»éŸ³ï¼‰
                this.questions = [];
                data.polyphones.forEach(poly => {
                    // éšæœºé€‰æ‹©ä¸€ä¸ªè¯»éŸ³
                    const readingIndex = Math.floor(Math.random() * poly.readings.length);
                    const reading = poly.readings[readingIndex];
                    // ä½¿ç”¨è¯¥è¯»éŸ³ä¸‹çš„ç¬¬ä¸€ä¸ªè¯ä½œä¸ºè€ƒå¯Ÿç›®æ ‡
                    const word = reading.words[0];

                    this.questions.push({
                        character: poly.character,
                        targetWord: word,
                        targetPinyin: reading.pinyin,
                        targetReadingIndex: readingIndex,
                        allReadings: poly.readings
                    });
                });

                // æ‰“ä¹±é¢˜ç›®é¡ºåº
                this.questions = this.shuffle(this.questions);
            }

            // è¦†ç›–åˆå§‹åŒ–æ–¹æ³•ï¼Œç¡®ä¿å¯¼èˆªæŒ‰é’®äº‹ä»¶åªç»‘å®šä¸€æ¬¡
            async init() {
                try {
                    await this.loadData();
                    this.render();
                    this.bindNavigationEvents(); // åªåœ¨åˆå§‹åŒ–æ—¶ç»‘å®šä¸€æ¬¡å¯¼èˆªæŒ‰é’®äº‹ä»¶
                    this.updateProgress();
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                    this.showError('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
            }

            render() {
                this.answered = false;
                const q = this.questions[this.currentIndex];
                this.currentQuestion = q;

                // åˆ›å»ºä¾‹å¥
                const sentence = this.generateSentence(q.targetWord, q.character);

                let html = `
                    <div class="polyphone-card">
                        <div class="main-character">${q.character}</div>
                        <div class="question-text">é€‰æ‹©"<strong>${q.targetWord}</strong>"ä¸­"${q.character}"çš„æ­£ç¡®è¯»éŸ³</div>
                        
                        <div class="readings-grid">
                            ${q.allReadings.map((reading, i) => `
                                <div class="reading-option" data-index="${i}" data-pinyin="${reading.pinyin}">
                                    <div class="reading-pinyin">${reading.pinyin}</div>
                                    <div class="reading-words">
                                        ${reading.words.map(w => `<span class="reading-word">${w}</span>`).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="word-sentence" style="display: none;" id="sentenceArea">
                            ${sentence}
                        </div>
                    </div>
                `;

                this.container.innerHTML = html;
                this.bindEvents();
                this.updateNavButtons();
                this.updateProgress();
            }

            generateSentence(word, character) {
                const sentences = {
                    'å‡æ—¥': 'æ¯ä¸ª<span class="highlight">å‡æ—¥</span>ï¼Œæˆ‘éƒ½ä¼šå’Œå®¶äººä¸€èµ·å»å…¬å›­æ•£æ­¥ã€‚',
                    'æ”¾å‡': 'æ˜å¤©å¼€å§‹<span class="highlight">æ”¾å‡</span>äº†ï¼ŒçœŸå¼€å¿ƒï¼',
                    'å‡å¦‚': '<span class="highlight">å‡å¦‚</span>æˆ‘æœ‰ä¸€åŒç¿…è†€ï¼Œå°±èƒ½é£ä¸Šå¤©ç©ºã€‚',
                    'çœŸå‡': 'è¿™å¹…ç”»çš„<span class="highlight">çœŸå‡</span>å¾ˆéš¾åˆ†è¾¨ã€‚',
                    'åèƒŒ': 'ä»–çš„<span class="highlight">åèƒŒ</span>è¢«å¤ªé˜³æ™’å¾—é€šçº¢ã€‚',
                    'èƒŒè´Ÿ': 'ä»–<span class="highlight">èƒŒè´Ÿ</span>ç€æ²‰é‡çš„è¡Œå›Šå‰è¡Œã€‚',
                    'åœ†åœˆ': 'è€å¸ˆåœ¨é»‘æ¿ä¸Šç”»äº†ä¸€ä¸ª<span class="highlight">åœ†åœˆ</span>ã€‚',
                    'ç¾Šåœˆ': 'ç‰§ç¾ŠäººæŠŠç¾Šèµ¶è¿›äº†<span class="highlight">ç¾Šåœˆ</span>ã€‚',
                    'æŒ‘æˆ˜': 'è¿™æ¬¡æ¯”èµ›æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„<span class="highlight">æŒ‘æˆ˜</span>ã€‚',
                    'æŒ‘æ°´': 'å¥¶å¥¶æ¯å¤©éƒ½è¦<span class="highlight">æŒ‘æ°´</span>æµ‡èœå›­ã€‚',
                };
                return sentences[word] || `è¿™ä¸ªè¯è¯­æ˜¯"<span class="highlight">${word}</span>"ã€‚`;
            }

            bindEvents() {
                const options = this.container.querySelectorAll('.reading-option');
                options.forEach(opt => {
                    opt.addEventListener('click', () => this.selectReading(opt));
                });
            }

            // ç»‘å®šå›ºå®šå¯¼èˆªæŒ‰é’®çš„äº‹ä»¶ï¼ˆåªè°ƒç”¨ä¸€æ¬¡ï¼‰
            bindNavigationEvents() {
                document.getElementById('prevBtn').addEventListener('click', () => this.prevQuestion());
                document.getElementById('nextBtn').addEventListener('click', () => this.nextQuestion());
                document.getElementById('backBtn').addEventListener('click', () => this.goBack());
                document.getElementById('speakBtn').addEventListener('click', () => {
                    const q = this.currentQuestion;
                    this.speak(`${q.character}ï¼Œ${q.targetPinyin}ï¼Œ${q.targetWord}`);
                });
            }

            updateNavButtons() {
                document.getElementById('prevBtn').disabled = this.currentIndex === 0;
            }

            selectReading(optEl) {
                if (this.answered) return;
                this.answered = true;

                const q = this.currentQuestion;
                const selectedIndex = parseInt(optEl.dataset.index);
                const isCorrect = selectedIndex === q.targetReadingIndex;

                optEl.classList.add('selected');

                if (isCorrect) {
                    optEl.classList.add('correct');
                    this.showCorrectFeedback();
                    this.correctCount++;

                    // æœ—è¯»
                    this.speak(q.targetWord);
                } else {
                    optEl.classList.add('wrong');
                    this.showWrongFeedback();

                    // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                    const correctOpt = this.container.querySelector(`.reading-option[data-index="${q.targetReadingIndex}"]`);
                    correctOpt.classList.add('correct');
                }

                // æ˜¾ç¤ºä¾‹å¥
                document.getElementById('sentenceArea').style.display = 'block';

                // æ˜¾ç¤ºæ‰€æœ‰é€‰é¡¹çš„ç»„è¯
                const allOptions = this.container.querySelectorAll('.reading-option');
                allOptions.forEach(opt => {
                    const wordsEl = opt.querySelector('.reading-words');
                    if (wordsEl) {
                        wordsEl.classList.add('show');
                    }
                });

                // è‡ªåŠ¨ä¸‹ä¸€é¢˜
                if (isCorrect) {
                    setTimeout(() => {
                        if (this.currentIndex < this.questions.length - 1) {
                            this.nextQuestion();
                        } else {
                            this.showComplete();
                        }
                    }, 2500);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const quiz = new PolyphoneQuiz({
                moduleId: 'polyphones'
            });
            quiz.init();
        });
    </script>
</body>

</html>