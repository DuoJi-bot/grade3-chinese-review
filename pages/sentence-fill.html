<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ­å¥é€‰æ‹©å¡«ç©º - ä¸‰å¹´çº§è¯­æ–‡å¤ä¹ </title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        .sentence-group {
            margin-bottom: 1.5rem;
        }

        .sentence-item {
            padding: 1rem;
            background: var(--bg-color);
            border-radius: var(--radius-lg);
            margin-bottom: 1rem;
            font-size: 1rem;
            line-height: 1.8;
            position: relative;
        }

        .reset-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.25rem 0.75rem;
            background: var(--warning-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all var(--transition-fast);
            opacity: 0.8;
        }

        .reset-btn:hover {
            opacity: 1;
            transform: scale(1.05);
        }

        .reset-btn:active {
            transform: scale(0.95);
        }

        .sentence-blank {
            display: inline-block;
            min-width: 100px;
            padding: 0.25rem 0.5rem;
            border-bottom: 2px dashed var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
            transition: all var(--transition-fast);
        }

        .sentence-blank::before {
            content: '?';
            opacity: 0.3;
            font-size: 1.2rem;
        }

        .sentence-blank.filled {
            background: var(--primary-color);
            color: white;
            border-radius: var(--radius-sm);
            border-bottom: none;
        }

        .sentence-blank.filled::before {
            content: none;
        }

        .sentence-blank.correct {
            background: var(--success-color);
        }

        .sentence-blank.wrong {
            background: var(--error-color);
        }

        .options-pool {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            padding: 1.5rem;
            background: var(--card-bg);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            margin-top: 1.5rem;
        }

        .option-tag {
            padding: 0.5rem 1rem;
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 0.875rem;
        }

        .option-tag:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .option-tag.used {
            opacity: 0.4;
            pointer-events: none;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
        }
    </style>
</head>

<body>
    <div class="quiz-container">
        <header class="quiz-header">
            <div class="quiz-back-btn" id="backBtn">
                <span>â†</span>
                <span>è¿”å›</span>
            </div>
            <h1 class="quiz-title" id="quizTitle">çŸ­å¥é€‰æ‹©å¡«ç©º</h1>
            <div class="quiz-progress" id="progressText">- / -</div>
        </header>

        <div class="progress-bar">
            <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
        </div>

        <div class="quiz-content" id="quizContent">
            <div class="loading">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <div class="nav-buttons">
            <button class="btn btn-outline" id="prevBtn">â† ä¸Šä¸€ç»„</button>
            <button class="btn btn-primary" id="checkBtn">âœ“ æ£€æŸ¥ç­”æ¡ˆ</button>
            <button class="btn btn-outline" id="nextBtn">ä¸‹ä¸€ç»„ â†’</button>
        </div>
    </div>

    <script src="../js/utils/tts.js"></script>
    <script src="../js/utils/storage.js"></script>
    <script src="../js/quiz-types/QuizBase.js"></script>
    <script>
        class SentenceFillQuiz extends QuizBase {
            constructor(options) {
                super(options);
                this.sections = [];
                this.currentSectionIndex = 0;
                this.selections = {};
            }

            async loadData() {
                const dataKey = this.getUrlParam('data') || 'character_traits';
                const data = await this.fetchJson('../data/character_morals.json');

                const section = data.sections.find(s => s.id === dataKey);
                if (section) {
                    document.getElementById('quizTitle').textContent = section.title;

                    // è·å–å·²ç­”å¯¹çš„é¢˜ç›®åˆ—è¡¨
                    const correctQuestions = window.storage.getCorrectQuestions(this.moduleId);

                    // åˆ†ç»„æ˜¾ç¤ºï¼Œæ¯ç»„5é¢˜ï¼ˆ10é¢˜åˆ†æˆ2é¡µï¼‰
                    const exercises = section.exercises || [];
                    const allGroups = [];
                    for (let i = 0; i < exercises.length; i += 5) {
                        allGroups.push({
                            items: exercises.slice(i, i + 5),
                            _groupIndex: Math.floor(i / 5)
                        });
                    }

                    // è¿‡æ»¤å·²ç­”å¯¹çš„é¢˜ç›®ç»„
                    this.questions = allGroups.filter(g => !correctQuestions.includes(String(g._groupIndex)));

                    // å¦‚æœæ‰€æœ‰é¢˜ç›®éƒ½å·²ç­”å¯¹ï¼Œé‡æ–°åŠ è½½æ‰€æœ‰é¢˜ç›®ä¾›å¤ä¹ 
                    if (this.questions.length === 0) {
                        this.questions = allGroups;
                        this.allCompleted = true;
                    }
                }
            }

            render() {
                const groupData = this.questions[this.currentIndex];
                const group = groupData.items || groupData; // å…¼å®¹æ–°æ—§æ•°æ®ç»“æ„
                this.currentGroupIndex = groupData._groupIndex !== undefined ? groupData._groupIndex : this.currentIndex;
                this.selections = {};

                // æ”¶é›†æ‰€æœ‰ç­”æ¡ˆ
                const allAnswers = [];
                group.forEach((item, idx) => {
                    if (item.answers) {
                        item.answers.forEach(a => allAnswers.push({ answer: a, index: idx }));
                    } else if (item.answer) {
                        allAnswers.push({ answer: item.answer, index: idx });
                    }
                });

                // æ‰“ä¹±ç­”æ¡ˆé¡ºåº
                const shuffledAnswers = this.shuffle(allAnswers);

                let html = `
                    <div class="sentence-group">
                        ${group.map((item, idx) => {
                    // å¤„ç†å¥å­ï¼Œå°†æ‹¬å·å†…å®¹æ›¿æ¢ä¸ºç©ºæ ¼
                    let sentence = item.sentence;
                    let blankCount = 0;
                    sentence = sentence.replace(/ï¼ˆ[^ï¼‰]+ï¼‰/g, (match) => {
                        const blankId = `blank-${idx}-${blankCount}`;
                        blankCount++;
                        return `<span class="sentence-blank" data-index="${idx}" data-blank-id="${blankId}" data-answer="${match.slice(1, -1)}"></span>`;
                    });

                    return `
                        <div class="sentence-item" data-item-index="${idx}">
                            ${sentence}
                            <button class="reset-btn" data-reset-index="${idx}">ğŸ”„ é‡ç½®</button>
                        </div>
                    `;
                }).join('')}
                    </div>
                    
                    <div class="options-pool">
                        ${shuffledAnswers.map((item, i) => `
                            <div class="option-tag" data-answer="${item.answer}" data-original-index="${item.index}">${item.answer}</div>
                        `).join('')}
                    </div>
                `;

                this.container.innerHTML = html;
                this.bindEvents();
                this.updateNavButtons();
                this.updateProgress();
            }

            bindEvents() {
                // åªç»‘å®šé€‰é¡¹å’Œç©ºæ ¼ç‚¹å‡»äº‹ä»¶ï¼ˆæ¯æ¬¡renderéœ€è¦é‡æ–°ç»‘å®šï¼‰
                const options = this.container.querySelectorAll('.option-tag');
                const blanks = this.container.querySelectorAll('.sentence-blank');
                const resetBtns = this.container.querySelectorAll('.reset-btn');

                let selectedOption = null;

                options.forEach(opt => {
                    opt.addEventListener('click', () => {
                        if (opt.classList.contains('used')) return;

                        // å–æ¶ˆä¹‹å‰çš„é€‰æ‹©
                        options.forEach(o => o.classList.remove('selected'));
                        opt.classList.add('selected');
                        selectedOption = opt;
                    });
                });

                blanks.forEach(blank => {
                    blank.addEventListener('click', () => {
                        if (blank.classList.contains('filled')) return;
                        if (!selectedOption) {
                            this.showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç­”æ¡ˆ');
                            return;
                        }

                        const answer = selectedOption.dataset.answer;
                        blank.textContent = answer;
                        blank.classList.add('filled');
                        blank.dataset.selected = answer;

                        selectedOption.classList.add('used');
                        selectedOption.classList.remove('selected');
                        selectedOption = null;
                    });
                });

                // ç»‘å®šé‡ç½®æŒ‰é’®äº‹ä»¶
                resetBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const itemIndex = btn.dataset.resetIndex;
                        this.resetItem(itemIndex);
                    });
                });
            }

            resetItem(itemIndex) {
                // æ‰¾åˆ°è¯¥é¢˜ç›®å¯¹åº”çš„æ‰€æœ‰ç©ºæ ¼
                const blanks = this.container.querySelectorAll(`.sentence-blank[data-index="${itemIndex}"]`);

                blanks.forEach(blank => {
                    if (blank.classList.contains('filled')) {
                        const filledAnswer = blank.dataset.selected;

                        // æ¢å¤é€‰é¡¹æ± ä¸­å¯¹åº”çš„é€‰é¡¹
                        const options = this.container.querySelectorAll('.option-tag');
                        options.forEach(opt => {
                            if (opt.dataset.answer === filledAnswer && opt.dataset.originalIndex === itemIndex) {
                                opt.classList.remove('used');
                            }
                        });

                        // æ¸…ç©ºç©ºæ ¼
                        blank.textContent = '';
                        blank.classList.remove('filled', 'correct', 'wrong');
                        delete blank.dataset.selected;
                    }
                });

                this.showToast('å·²é‡ç½®è¯¥é¢˜');
            }

            // å¯¼èˆªæŒ‰é’®äº‹ä»¶åªç»‘å®šä¸€æ¬¡
            bindNavEvents() {
                if (this._navBound) return;
                this._navBound = true;

                document.getElementById('prevBtn').addEventListener('click', () => this.prevQuestion());
                document.getElementById('nextBtn').addEventListener('click', () => this.nextQuestion());
                document.getElementById('backBtn').addEventListener('click', () => this.goBack());
                document.getElementById('checkBtn').addEventListener('click', () => this.checkAnswers());
            }

            updateNavButtons() {
                document.getElementById('prevBtn').disabled = this.currentIndex === 0;
            }

            checkAnswers() {
                const blanks = this.container.querySelectorAll('.sentence-blank');
                let correct = 0;
                let total = blanks.length;

                blanks.forEach(blank => {
                    const selected = blank.dataset.selected;
                    const answer = blank.dataset.answer;

                    if (!selected) {
                        blank.classList.add('wrong');
                        blank.textContent = answer;
                    } else if (selected === answer) {
                        blank.classList.add('correct');
                        correct++;
                    } else {
                        blank.classList.add('wrong');
                        // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                        blank.textContent = answer;
                    }
                });

                this.correctCount += correct;

                if (correct === total) {
                    this.showCorrectFeedback();
                    // è®°å½•ç­”å¯¹çš„é¢˜ç›®ç»„
                    window.storage.markQuestionCorrect(this.moduleId, this.currentGroupIndex);

                    setTimeout(() => {
                        if (this.currentIndex < this.questions.length - 1) {
                            this.nextQuestion();
                        } else {
                            this.showComplete();
                        }
                    }, 1500);
                } else {
                    this.showToast(`æ­£ç¡® ${correct}/${total}`);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const quiz = new SentenceFillQuiz({
                moduleId: new URLSearchParams(window.location.search).get('id') || 'sentence-fill'
            });
            quiz.init().then(() => {
                quiz.bindNavEvents(); // å¯¼èˆªæŒ‰é’®åªç»‘å®šä¸€æ¬¡
            });
        });
    </script>
</body>

</html>