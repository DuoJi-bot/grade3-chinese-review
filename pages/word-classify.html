<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯è¯­åˆ†ç±»ç»ƒä¹  - ä¸‰å¹´çº§è¯­æ–‡å¤ä¹ </title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        .word-pool {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            padding: 1.5rem;
            background: var(--bg-color);
            border-radius: var(--radius-lg);
            margin-bottom: 1.5rem;
            min-height: 80px;
        }

        .word-item {
            padding: 0.5rem 1rem;
            font-size: 1rem;
            font-weight: 500;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all var(--transition-fast);
            user-select: none;
        }

        .word-item:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .word-item.selected {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.2);
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .word-item.placed {
            background: var(--success-light);
            border-color: var(--success-color);
            color: white;
            cursor: default;
        }

        .word-item.wrong {
            background: var(--error-light);
            border-color: var(--error-color);
            color: white;
        }

        .category-zones {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
        }

        .category-zone {
            background: var(--bg-color);
            border-radius: var(--radius-xl);
            padding: 1rem;
            min-height: 180px;
            text-align: center;
            transition: all var(--transition-fast);
            border: 2px dashed var(--border-color);
            cursor: pointer;
        }

        .category-zone:hover {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.05);
        }

        .category-zone.active {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }

        .category-zone-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .category-zone-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        .category-zone-items {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            min-height: 50px;
        }

        .placed-word {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            background: var(--primary-color);
            color: white;
            border-radius: var(--radius-md);
        }

        .hint-text {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-top: 1.5rem;
        }
    </style>
</head>

<body>
    <div class="quiz-container">
        <header class="quiz-header">
            <div class="quiz-back-btn" id="backBtn">
                <span>â†</span>
                <span>è¿”å›</span>
            </div>
            <h1 class="quiz-title" id="quizTitle">è¯è¯­åˆ†ç±»ç»ƒä¹ </h1>
            <div class="quiz-progress" id="progressText">- / -</div>
        </header>

        <div class="progress-bar">
            <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
        </div>

        <div class="quiz-content" id="quizContent">
            <div class="loading">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <div class="nav-buttons">
            <button class="btn btn-outline" id="resetBtn">ğŸ”„ é‡ç½®</button>
            <button class="btn btn-primary" id="checkBtn">âœ“ æ£€æŸ¥ç­”æ¡ˆ</button>
        </div>
    </div>

    <script src="../js/utils/tts.js"></script>
    <script src="../js/utils/storage.js"></script>
    <script src="../js/quiz-types/QuizBase.js"></script>
    <script>
        /**
         * è¯è¯­åˆ†ç±»å½’çº³é¢˜å‹
         * å°†è¯è¯­æ‹–æ‹½åˆ°å¯¹åº”çš„åˆ†ç±»ä¸­
         */
        class WordClassifyQuiz extends QuizBase {
            constructor(options) {
                super(options);
                this.categories = [];
                this.allWords = [];
                this.placements = {}; // è®°å½•æ¯ä¸ªè¯è¯­æ”¾ç½®çš„ä½ç½®
            }

            async loadData() {
                const data = await this.fetchJson('../data/word_classify.json');
                const section = data.sections.find(s => s.id === 'seasons');

                if (section) {
                    this.categories = section.categories;
                    document.getElementById('quizTitle').textContent = section.title;

                    // æ”¶é›†æ‰€æœ‰è¯è¯­
                    this.allWords = [];
                    this.categories.forEach(cat => {
                        cat.words.forEach(word => {
                            this.allWords.push({
                                word: word,
                                category: cat.name
                            });
                        });
                    });

                    // åªæœ‰ä¸€é“é¢˜ -> æ”¹ä¸ºï¼šæ¯ä¸ªè¯è¯­è§†ä¸ºä¸€é“é¢˜
                    this.questions = this.allWords;
                }
            }

            render() {
                // æ‰“ä¹±è¯è¯­é¡ºåº
                const shuffledWords = this.shuffle(this.allWords);

                // è¯è¯­æ± ï¼ˆç§»é™¤draggableå±æ€§ï¼‰
                let poolHtml = '<div class="word-pool" id="wordPool">';
                shuffledWords.forEach((item, index) => {
                    poolHtml += `<div class="word-item" data-word="${item.word}" data-category="${item.category}" data-index="${index}">${item.word}</div>`;
                });
                poolHtml += '</div>';

                // åˆ†ç±»åŒºåŸŸ
                let zonesHtml = '<div class="category-zones">';
                this.categories.forEach(cat => {
                    zonesHtml += `
                        <div class="category-zone" data-category="${cat.name}">
                            <div class="category-zone-icon">${cat.icon}</div>
                            <div class="category-zone-title">${cat.name}</div>
                            <div class="category-zone-keyword">${cat.keyword}</div>
                            <div class="category-zone-items" data-category="${cat.name}"></div>
                        </div>
                    `;
                });
                zonesHtml += '</div>';

                const hintHtml = '<p class="hint-text">é€‰æ‹©è¯è¯­ç„¶åç‚¹å‡»å¯¹åº”çš„å­£èŠ‚åˆ†ç±»</p>';

                this.container.innerHTML = poolHtml + zonesHtml + hintHtml;

                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                this.bindClickEvents();
                this.bindButtonEvents();
                this.updateProgress();
            }

            bindClickEvents() {
                const wordItems = this.container.querySelectorAll('.word-item');
                const zones = this.container.querySelectorAll('.category-zone');

                // è¯è¯­ç‚¹å‡»é€‰æ‹©
                wordItems.forEach(item => {
                    item.addEventListener('click', () => {
                        if (item.classList.contains('placed')) return;

                        // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
                        const wasSelected = item.classList.contains('selected');
                        wordItems.forEach(i => i.classList.remove('selected'));

                        if (!wasSelected) {
                            item.classList.add('selected');
                            // æœ—è¯»è¯è¯­
                            this.speak(item.dataset.word);
                        }
                    });
                });

                // åˆ†ç±»åŒºåŸŸç‚¹å‡»æ”¾ç½®
                zones.forEach(zone => {
                    zone.addEventListener('click', (e) => {
                        // é˜²æ­¢ç‚¹å‡»å·²æ”¾ç½®çš„è¯è¯­è§¦å‘
                        if (e.target.classList.contains('placed-word')) return;

                        const selectedItem = this.container.querySelector('.word-item.selected');
                        if (selectedItem) {
                            const word = selectedItem.dataset.word;
                            const correctCategory = selectedItem.dataset.category;
                            const targetCategory = zone.dataset.category;

                            this.placeWord(word, targetCategory, correctCategory);
                            selectedItem.classList.remove('selected');

                            // çŸ­æš‚é«˜äº®åˆ†ç±»åŒºåŸŸ
                            zone.classList.add('active');
                            setTimeout(() => zone.classList.remove('active'), 300);
                        }
                    });
                });
            }

            placeWord(word, targetCategory, correctCategory) {
                const wordItem = this.container.querySelector(`.word-item[data-word="${word}"]`);
                if (!wordItem || wordItem.classList.contains('placed')) return;

                // è®°å½•æ”¾ç½®
                this.placements[word] = {
                    target: targetCategory,
                    correct: correctCategory,
                    isCorrect: targetCategory === correctCategory
                };

                // æ›´æ–°è¯è¯­çŠ¶æ€
                wordItem.classList.add('placed');

                // æ·»åŠ åˆ°ç›®æ ‡åŒºåŸŸ
                const zoneItems = this.container.querySelector(`.category-zone-items[data-category="${targetCategory}"]`);
                const placedWord = document.createElement('span');
                placedWord.className = 'placed-word';
                placedWord.textContent = word;
                placedWord.dataset.word = word;
                zoneItems.appendChild(placedWord);

                // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨æ”¾ç½®å®Œæˆ
                this.checkAllPlaced();
            }

            checkAllPlaced() {
                const remaining = this.container.querySelectorAll('.word-item:not(.placed)');
                if (remaining.length === 0) {
                    document.getElementById('checkBtn').classList.add('pulse');
                }
            }

            bindButtonEvents() {
                document.getElementById('backBtn').addEventListener('click', () => this.goBack());

                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.placements = {};
                    this.render();
                });

                document.getElementById('checkBtn').addEventListener('click', () => {
                    this.checkAnswers();
                });
            }

            checkAnswers() {
                let correctCount = 0;
                let totalCount = Object.keys(this.placements).length;

                if (totalCount === 0) {
                    this.showToast('è¯·å…ˆå°†è¯è¯­åˆ†ç±»');
                    return;
                }

                // æ£€æŸ¥æ¯ä¸ªæ”¾ç½®çš„è¯è¯­
                Object.entries(this.placements).forEach(([word, placement]) => {
                    const placedWord = this.container.querySelector(`.placed-word[data-word="${word}"]`);
                    const wordItem = this.container.querySelector(`.word-item[data-word="${word}"]`);

                    if (placement.isCorrect) {
                        correctCount++;
                        if (placedWord) placedWord.style.background = 'var(--success-color)';
                        if (wordItem) wordItem.classList.add('correct');
                    } else {
                        if (placedWord) placedWord.style.background = 'var(--error-color)';
                        if (wordItem) wordItem.classList.add('wrong');
                    }
                });

                // æ›´æ–°ç»Ÿè®¡
                this.correctCount = correctCount;

                if (correctCount === totalCount && totalCount === this.allWords.length) {
                    this.showCorrectFeedback();
                    // è®°å½•ç­”å¯¹çš„é¢˜ç›®ï¼ˆæ‰€æœ‰è¯è¯­ï¼‰
                    this.allWords.forEach(w => {
                        window.storage.markQuestionCorrect(this.moduleId, w.word);
                    });
                    setTimeout(() => this.showComplete(), 1000);
                } else if (totalCount === this.allWords.length) {
                    this.showToast(`æ­£ç¡® ${correctCount}/${totalCount}ï¼Œå†è¯•ä¸€æ¬¡å§ï¼`);
                } else {
                    this.showToast(`å·²åˆ†ç±» ${totalCount}/${this.allWords.length}ï¼Œè¯·ç»§ç»­åˆ†ç±»`);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const quiz = new WordClassifyQuiz({
                moduleId: 'season-words'  // åŒ¹é…main.jsä¸­çš„MODULE_TOTAL_QUESTIONSé…ç½®
            });
            quiz.init();
        });
    </script>
</body>

</html>