<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ®µè½é€‰æ‹©å¡«ç©º - ä¸‰å¹´çº§è¯­æ–‡å¤ä¹ </title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        .lesson-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            padding: 0.5rem;
            background: var(--bg-color);
            border-radius: var(--radius-lg);
        }

        .lesson-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
        }

        .lesson-btn:hover,
        .lesson-btn.active {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }

        .lesson-btn.completed {
            border-color: var(--success-color);
            border-width: 2px;
            box-shadow: 0 0 0 1px var(--success-color);
        }

        .lesson-btn.completed:not(.active)::after {
            content: ' âœ“';
            color: var(--success-color);
        }

        .paragraph-area {
            padding: 1.5rem;
            background: var(--bg-color);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            line-height: 2;
            color: var(--text-primary);
        }

        .paragraph-blank {
            display: inline-block;
            min-width: 80px;
            padding: 0.2rem 0.5rem;
            border-bottom: 2px dashed var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .paragraph-blank::before {
            content: '?';
            opacity: 0.3;
            font-size: 1rem;
        }

        .paragraph-blank:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .paragraph-blank.filled {
            background: var(--primary-color);
            color: white;
            border-radius: var(--radius-sm);
            border-bottom: none;
        }

        .paragraph-blank.filled::before {
            content: none;
        }

        .paragraph-blank.correct {
            background: var(--success-color);
        }

        .paragraph-blank.wrong {
            background: var(--error-color);
        }

        .options-pool {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            padding: 1rem;
            margin-top: 1.5rem;
            background: var(--card-bg);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
        }

        .option-tag {
            padding: 0.4rem 0.8rem;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 0.875rem;
        }

        .option-tag:hover {
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .option-tag.selected {
            border-color: var(--primary-color);
            background: var(--primary-light);
            color: white;
        }

        .option-tag.used {
            opacity: 0.4;
            pointer-events: none;
        }

        .hint-text {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 1rem;
        }

        .paragraph-item {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .paragraph-item:last-child {
            margin-bottom: 0;
        }

        .paragraph-reset-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.25rem 0.75rem;
            background: var(--warning-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all var(--transition-fast);
            opacity: 0.8;
            z-index: 10;
        }

        .paragraph-reset-btn:hover {
            opacity: 1;
            transform: scale(1.05);
        }

        .paragraph-reset-btn:active {
            transform: scale(0.95);
        }

        .poem-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            border-left: 4px solid var(--primary-color);
            position: relative;
        }

        .poem-section:last-child {
            margin-bottom: 0;
        }

        .poem-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px dashed var(--border-color);
        }

        .poem-reset-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.25rem 0.75rem;
            background: var(--warning-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all var(--transition-fast);
            opacity: 0.8;
            z-index: 10;
        }

        .poem-reset-btn:hover {
            opacity: 1;
            transform: scale(1.05);
        }

        .poem-reset-btn:active {
            transform: scale(0.95);
        }

        .poem-section .paragraph-area {
            margin-bottom: 1rem;
        }

        .poem-section .paragraph-area:last-child {
            margin-bottom: 1rem;
        }

        .poem-section .options-pool {
            margin-top: 1rem;
            background: var(--bg-color);
        }
    </style>
</head>

<body>
    <div class="quiz-container">
        <header class="quiz-header">
            <div class="quiz-back-btn" id="backBtn">
                <span>â†</span>
                <span>è¿”å›</span>
            </div>
            <h1 class="quiz-title">è¯¾æ–‡çŸ¥è¯†ç‚¹å¡«ç©º</h1>
            <div class="quiz-progress" id="progressText"></div>
        </header>

        <div class="quiz-content" id="quizContent">
            <div class="loading">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <div class="nav-buttons">
            <button class="btn btn-outline" id="resetBtn">ğŸ”„ é‡ç½®</button>
            <button class="btn btn-primary" id="checkBtn">âœ“ æ£€æŸ¥ç­”æ¡ˆ</button>
            <button class="btn btn-outline" id="nextBtn">ä¸‹ä¸€è¯¾ â†’</button>
        </div>
    </div>

    <script src="../js/utils/tts.js"></script>
    <script src="../js/utils/storage.js"></script>
    <script src="../js/quiz-types/QuizBase.js"></script>
    <script>
        class ParagraphFillQuiz extends QuizBase {
            constructor(options) {
                super(options);
                this.lessons = [];
                this.selectedOptions = {}; // è®°å½•æ¯ä¸ªç©ºæ ¼é€‰ä¸­çš„é€‰é¡¹
                this.currentLessonIndex = 0; // å½“å‰è¯¾
            }

            async loadData() {
                const data = await this.fetchJson('../data/course_knowledge.json');
                this.lessons = data.lessons;
                this.questions = this.lessons;
            }

            // è¦†ç›–åˆå§‹åŒ–æ–¹æ³•ï¼Œç¡®ä¿å¯¼èˆªæŒ‰é’®äº‹ä»¶åªç»‘å®šä¸€æ¬¡
            async init() {
                try {
                    await this.loadData();
                    this.render();
                    this.bindNavigationEvents(); // åªåœ¨åˆå§‹åŒ–æ—¶ç»‘å®šä¸€æ¬¡å¯¼èˆªæŒ‰é’®äº‹ä»¶
                    this.updateProgress();
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                    this.showError('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
            }

            render() {
                const lesson = this.lessons[this.currentLessonIndex];
                this.selectedOptions = {}; // é‡ç½®é€‰é¡¹

                // æ£€æŸ¥å½“å‰è¯¾æ˜¯å¦æ˜¯å¤šéƒ¨åˆ†è¯¾æ–‡ï¼ˆå¦‚"å¤è¯—ä¸‰é¦–"ï¼‰
                // é€šè¿‡æ£€æµ‹lesson.idæ˜¯å¦åŒ…å«ä¸‹åˆ’çº¿æ¥åˆ¤æ–­ï¼ˆå¦‚lesson4_wangdongtingï¼‰
                const isMultiPartLesson = lesson.id && lesson.id.includes('_');

                let lessonsToRender = [];
                let allBlanks = [];
                let lessonPrefix = '';

                if (isMultiPartLesson) {
                    // å¤šéƒ¨åˆ†è¯¾æ–‡ï¼šæå–è¯¾å·å‰ç¼€ï¼ˆå¦‚lesson4ï¼‰ï¼Œæ‰¾å‡ºæ‰€æœ‰åŒè¯¾å·çš„éƒ¨åˆ†
                    lessonPrefix = lesson.id.split('_')[0]; // æå–lesson4
                    lessonsToRender = this.lessons.filter(l => l.id && l.id.startsWith(lessonPrefix + '_'));
                    lessonsToRender.forEach(l => {
                        l.paragraphs.forEach(p => {
                            allBlanks.push(...p.blanks);
                        });
                    });
                } else {
                    // æ™®é€šè¯¾æ–‡ï¼šåªæ¸²æŸ“å½“å‰è¯¾
                    lessonsToRender = [lesson];
                    lesson.paragraphs.forEach(p => {
                        allBlanks.push(...p.blanks);
                    });
                }

                // ç”Ÿæˆé€‰é¡¹æ± ï¼ˆåŒ…å«æ‰€æœ‰ç­”æ¡ˆå’Œä¸€äº›å¹²æ‰°é¡¹ï¼‰
                const distractors = this.generateDistractors(allBlanks);
                const allOptions = this.shuffle([...allBlanks, ...distractors]);

                // ç”Ÿæˆæ‰€æœ‰æ®µè½çš„HTML
                let paragraphsHtml = '';

                if (isMultiPartLesson) {
                    // å¤šéƒ¨åˆ†è¯¾æ–‡ï¼šæŒ‰éƒ¨åˆ†åˆ†å—æ˜¾ç¤ºï¼Œæ¯éƒ¨åˆ†æœ‰ç‹¬ç«‹çš„é€‰é¡¹æ± 
                    paragraphsHtml = lessonsToRender.map((poemLesson, lessonIdx) => {
                        const poemTitle = poemLesson.title.split('- ')[1]; // æå–å¤è¯—åç§°

                        // æ”¶é›†å½“å‰å¤è¯—çš„æ‰€æœ‰ç­”æ¡ˆ
                        const poemBlanks = [];
                        poemLesson.paragraphs.forEach(p => {
                            poemBlanks.push(...p.blanks);
                        });

                        // ä¸ºå½“å‰å¤è¯—ç”Ÿæˆç‹¬ç«‹çš„é€‰é¡¹æ± 
                        const poemDistractors = this.generateDistractors(poemBlanks);
                        const poemOptions = this.shuffle([...poemBlanks, ...poemDistractors]);

                        // ç”Ÿæˆæ®µè½HTML
                        const poemParagraphs = poemLesson.paragraphs.map((paragraph, pIndex) => {
                            let text = paragraph.text;
                            let blankIndex = 0;
                            const uniqueId = `l${lessonIdx}_p${pIndex}`;

                            // æ›¿æ¢æ‹¬å·å†…å®¹ä¸ºç©ºæ ¼
                            const displayText = text.replace(/ï¼ˆ[^ï¼‰]+ï¼‰/g, (match) => {
                                const answer = match.slice(1, -1);
                                const blankId = `${uniqueId}_b${blankIndex}`;
                                const html = `<span class="paragraph-blank" data-poem-index="${lessonIdx}" data-id="${blankId}" data-answer="${answer}"></span>`;
                                blankIndex++;
                                return html;
                            });

                            return `<div class="paragraph-area">${displayText}</div>`;
                        }).join('');

                        // ç”Ÿæˆå½“å‰å¤è¯—çš„é€‰é¡¹æ± 
                        const poemOptionsHtml = `
                            <div class="options-pool">
                                ${poemOptions.map(opt => `
                                    <div class="option-tag" data-value="${opt}">${opt}</div>
                                `).join('')}
                            </div>
                        `;

                        return `
                            <div class="poem-section" data-poem-index="${lessonIdx}">
                                <button class="poem-reset-btn" data-reset-poem="${lessonIdx}">ğŸ”„ é‡ç½®</button>
                                <h3 class="poem-title">${poemTitle}</h3>
                                ${poemParagraphs}
                                ${poemOptionsHtml}
                            </div>
                        `;
                    }).join('');
                } else {
                    // æ™®é€šè¯¾æ–‡ï¼šç›´æ¥æ˜¾ç¤ºæ‰€æœ‰æ®µè½
                    paragraphsHtml = lesson.paragraphs.map((paragraph, pIndex) => {
                        let text = paragraph.text;
                        let blankIndex = 0;

                        // æ›¿æ¢æ‹¬å·å†…å®¹ä¸ºç©ºæ ¼
                        const displayText = text.replace(/ï¼ˆ[^ï¼‰]+ï¼‰/g, (match) => {
                            const answer = match.slice(1, -1);
                            const uniqueId = `p${pIndex}_b${blankIndex}`;
                            const html = `<span class="paragraph-blank" data-paragraph-index="${pIndex}" data-id="${uniqueId}" data-answer="${answer}"></span>`;
                            blankIndex++;
                            return html;
                        });

                        return `
                            <div class="paragraph-item" data-paragraph-index="${pIndex}">
                                <button class="paragraph-reset-btn" data-reset-paragraph="${pIndex}">ğŸ”„ é‡ç½®</button>
                                <div class="paragraph-area">
                                    ${displayText}
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // ç”Ÿæˆè¯¾æ–‡é€‰æ‹©å™¨ï¼ˆåˆå¹¶å¤šéƒ¨åˆ†è¯¾æ–‡ï¼‰
                const lessonButtons = this.getLessonButtons();

                let html = '';

                if (isMultiPartLesson) {
                    // å¤šéƒ¨åˆ†è¯¾æ–‡ï¼šå„éƒ¨åˆ†å·²åŒ…å«å„è‡ªçš„é€‰é¡¹æ± 
                    html = `
                        <div class="lesson-selector">
                            ${lessonButtons}
                        </div>

                        <div class="paragraphs-container">
                            ${paragraphsHtml}
                        </div>

                        <p class="hint-text">å…ˆç‚¹å‡»é€‰é¡¹ï¼Œå†ç‚¹å‡»ç©ºæ ¼å¡«å…¥</p>
                    `;
                } else {
                    // æ™®é€šè¯¾æ–‡ï¼šç»Ÿä¸€çš„é€‰é¡¹æ± 
                    html = `
                        <div class="lesson-selector">
                            ${lessonButtons}
                        </div>

                        <div class="paragraphs-container">
                            ${paragraphsHtml}
                        </div>

                        <div class="options-pool">
                            ${allOptions.map(opt => `
                                <div class="option-tag" data-value="${opt}">${opt}</div>
                            `).join('')}
                        </div>

                        <p class="hint-text">å…ˆç‚¹å‡»é€‰é¡¹ï¼Œå†ç‚¹å‡»ç©ºæ ¼å¡«å…¥</p>
                    `;
                }

                this.container.innerHTML = html;
                this.bindEvents();
                this.updateProgress();
            }

            // è·å–æŒ‰è¯¾å·æ’åºçš„è¯¾æ–‡ç´¢å¼•åˆ—è¡¨
            getSortedLessonIndices() {
                const processedPrefixes = new Set();
                const lessonData = [];

                // æ”¶é›†æ‰€æœ‰è¯¾å·åŠå…¶ç¬¬ä¸€ä¸ªå‡ºç°çš„ç´¢å¼•
                this.lessons.forEach((l, i) => {
                    if (l.id && l.id.includes('_')) {
                        // å¤šéƒ¨åˆ†è¯¾æ–‡ï¼ˆå¦‚å¤è¯—ä¸‰é¦–ï¼‰
                        const prefix = l.id.split('_')[0];
                        if (!processedPrefixes.has(prefix)) {
                            processedPrefixes.add(prefix);
                            const lessonNum = parseInt(prefix.replace('lesson', ''));
                            lessonData.push({ index: i, sortKey: lessonNum, prefix: prefix });
                        }
                    } else {
                        // æ™®é€šè¯¾æ–‡
                        const lessonNum = parseInt(l.id.replace('lesson', ''));
                        lessonData.push({ index: i, sortKey: lessonNum, prefix: null });
                    }
                });

                // æŒ‰è¯¾å·æ•°å­—æ’åº
                lessonData.sort((a, b) => a.sortKey - b.sortKey);

                // è¿”å›æ’åºåçš„ç´¢å¼•åˆ—è¡¨
                return lessonData.map(item => item.index);
            }

            getLessonButtons() {
                const buttons = [];
                const processedPrefixes = new Set(); // è®°å½•å·²å¤„ç†çš„è¯¾å·å‰ç¼€

                // è·å–å·²å®Œæˆçš„è¯¾æ—¶åˆ—è¡¨
                const completedLessons = window.storage.getCorrectQuestions(this.moduleId);

                // åˆ›å»ºå¸¦æ’åºä¿¡æ¯çš„æŒ‰é’®æ•°æ®
                const buttonData = [];

                this.lessons.forEach((l, i) => {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å¤šéƒ¨åˆ†è¯¾æ–‡ï¼ˆåŒ…å«ä¸‹åˆ’çº¿ï¼‰
                    if (l.id && l.id.includes('_')) {
                        const prefix = l.id.split('_')[0]; // æå–è¯¾å·å‰ç¼€ï¼ˆå¦‚lesson4ï¼‰

                        // åªåœ¨ç¬¬ä¸€æ¬¡é‡åˆ°è¯¥è¯¾å·æ—¶æ·»åŠ æŒ‰é’®
                        if (!processedPrefixes.has(prefix)) {
                            processedPrefixes.add(prefix);

                            // æ£€æŸ¥å½“å‰é€‰ä¸­çš„è¯¾æ–‡æ˜¯å¦å±äºè¿™ä¸ªè¯¾å·
                            const currentLessonId = this.lessons[this.currentLessonIndex].id;
                            const isActive = currentLessonId && currentLessonId.startsWith(prefix + '_');

                            // æ£€æŸ¥è¯¥è¯¾æ—¶æ˜¯å¦å·²å®Œæˆ
                            const isCompleted = completedLessons.includes(l.id);

                            // ä»æ ‡é¢˜ä¸­æå–è¯¾æ–‡åç§°ï¼ˆå¦‚"ç¬¬4è¯¾ã€Šå¤è¯—ä¸‰é¦–ã€‹"ï¼‰
                            const mainTitle = l.title.split('- ')[0]; // å»æ‰" - å¤è¯—å"éƒ¨åˆ†

                            // æå–è¯¾å·æ•°å­—ç”¨äºæ’åºï¼ˆå¦‚"lesson4" -> 4ï¼‰
                            const lessonNum = parseInt(prefix.replace('lesson', ''));

                            buttonData.push({
                                html: `<button class="lesson-btn ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}" data-index="${i}">${mainTitle}</button>`,
                                sortKey: lessonNum
                            });
                        }
                    } else {
                        // æ™®é€šè¯¾æ–‡
                        const displayTitle = l.title.length > 15 ? l.title.slice(0, 15) + '...' : l.title;

                        // æ£€æŸ¥è¯¥è¯¾æ—¶æ˜¯å¦å·²å®Œæˆ
                        const isCompleted = completedLessons.includes(l.id);

                        // æå–è¯¾å·æ•°å­—ç”¨äºæ’åºï¼ˆå¦‚"lesson1" -> 1ï¼‰
                        const lessonNum = parseInt(l.id.replace('lesson', ''));

                        buttonData.push({
                            html: `<button class="lesson-btn ${i === this.currentLessonIndex ? 'active' : ''} ${isCompleted ? 'completed' : ''}" data-index="${i}">${displayTitle}</button>`,
                            sortKey: lessonNum
                        });
                    }
                });

                // æŒ‰è¯¾å·æ•°å­—æ’åº
                buttonData.sort((a, b) => a.sortKey - b.sortKey);

                // æå–æ’åºåçš„HTML
                return buttonData.map(item => item.html).join('');
            }

            generateDistractors(blanks) {
                // ä»å…¶ä»–è¯¾æ–‡è·å–å¹²æ‰°é€‰é¡¹
                const allBlanks = [];
                this.lessons.forEach(l => {
                    l.paragraphs.forEach(p => {
                        allBlanks.push(...p.blanks);
                    });
                });

                const unique = [...new Set(allBlanks)].filter(b => !blanks.includes(b));
                return this.shuffle(unique).slice(0, Math.min(3, blanks.length));
            }

            bindEvents() {
                const lesson = this.lessons[this.currentLessonIndex];
                const isMultiPartLesson = lesson.id && lesson.id.includes('_');

                if (isMultiPartLesson) {
                    // å¤šéƒ¨åˆ†è¯¾æ–‡ï¼šä¸ºæ¯ä¸ªéƒ¨åˆ†å—ç»‘å®šç‹¬ç«‹çš„äº‹ä»¶
                    const poemSections = this.container.querySelectorAll('.poem-section');
                    poemSections.forEach(section => {
                        const options = section.querySelectorAll('.option-tag');
                        const blanks = section.querySelectorAll('.paragraph-blank');
                        const resetBtn = section.querySelector('.poem-reset-btn');
                        let selectedOption = null;

                        options.forEach(opt => {
                            opt.addEventListener('click', () => {
                                if (opt.classList.contains('used')) return;
                                options.forEach(o => o.classList.remove('selected'));
                                opt.classList.add('selected');
                                selectedOption = opt;
                            });
                        });

                        blanks.forEach(blank => {
                            blank.addEventListener('click', () => {
                                if (blank.classList.contains('filled')) return;
                                if (!selectedOption) {
                                    this.showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç­”æ¡ˆ');
                                    return;
                                }

                                const value = selectedOption.dataset.value;
                                blank.textContent = value;
                                blank.classList.add('filled');
                                blank.dataset.selected = value;

                                selectedOption.classList.add('used');
                                selectedOption.classList.remove('selected');
                                selectedOption = null;
                            });
                        });

                        // ç»‘å®šå¤è¯—é‡ç½®æŒ‰é’®äº‹ä»¶
                        if (resetBtn) {
                            resetBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const poemIndex = resetBtn.dataset.resetPoem;
                                this.resetPoem(poemIndex);
                            });
                        }
                    });
                } else {
                    // æ™®é€šè¯¾æ–‡ï¼šç»Ÿä¸€çš„é€‰é¡¹æ± å’Œç©ºæ ¼
                    const options = this.container.querySelectorAll('.option-tag');
                    const blanks = this.container.querySelectorAll('.paragraph-blank');
                    const resetBtns = this.container.querySelectorAll('.paragraph-reset-btn');

                    options.forEach(opt => {
                        opt.addEventListener('click', () => {
                            if (opt.classList.contains('used')) return;
                            options.forEach(o => o.classList.remove('selected'));
                            opt.classList.add('selected');
                            this.selectedOption = opt;
                        });
                    });

                    blanks.forEach(blank => {
                        blank.addEventListener('click', () => {
                            if (blank.classList.contains('filled')) return;
                            if (!this.selectedOption) {
                                this.showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç­”æ¡ˆ');
                                return;
                            }

                            const value = this.selectedOption.dataset.value;
                            blank.textContent = value;
                            blank.classList.add('filled');
                            blank.dataset.selected = value;

                            this.selectedOption.classList.add('used');
                            this.selectedOption.classList.remove('selected');
                            this.selectedOption = null;
                        });
                    });

                    // ç»‘å®šé‡ç½®æŒ‰é’®äº‹ä»¶
                    resetBtns.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const paragraphIndex = btn.dataset.resetParagraph;
                            this.resetParagraph(paragraphIndex);
                        });
                    });
                }

                // è¯¾æ–‡åˆ‡æ¢
                const lessonBtns = this.container.querySelectorAll('.lesson-btn');
                lessonBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.currentLessonIndex = parseInt(btn.dataset.index);
                        this.render();
                    });
                });

            }

            // ç»‘å®šå›ºå®šå¯¼èˆªæŒ‰é’®çš„äº‹ä»¶ï¼ˆåªè°ƒç”¨ä¸€æ¬¡ï¼‰
            bindNavigationEvents() {
                document.getElementById('backBtn').addEventListener('click', () => this.goBack());
                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.render();
                });
                document.getElementById('checkBtn').addEventListener('click', () => this.checkAnswers());
                document.getElementById('nextBtn').addEventListener('click', () => {
                    // è·å–æŒ‰è¯¾å·æ’åºçš„è¯¾æ–‡ç´¢å¼•åˆ—è¡¨
                    const sortedIndices = this.getSortedLessonIndices();

                    // æ‰¾åˆ°å½“å‰è¯¾æ–‡åœ¨æ’åºåˆ—è¡¨ä¸­çš„ä½ç½®
                    let currentPosition = sortedIndices.indexOf(this.currentLessonIndex);

                    // å¦‚æœå½“å‰æ˜¯å¤šéƒ¨åˆ†è¯¾æ–‡(å¦‚å¤è¯—ä¸‰é¦–çš„ç¬¬2æˆ–ç¬¬3é¦–)ï¼Œéœ€è¦æ‰¾åˆ°å¯¹åº”çš„è¯¾å·ä½ç½®
                    if (currentPosition === -1) {
                        const currentLesson = this.lessons[this.currentLessonIndex];
                        if (currentLesson.id && currentLesson.id.includes('_')) {
                            const prefix = currentLesson.id.split('_')[0];
                            // æ‰¾åˆ°è¯¥è¯¾å·å¯¹åº”çš„ç¬¬ä¸€éƒ¨åˆ†åœ¨æ’åºåˆ—è¡¨ä¸­çš„ä½ç½®
                            currentPosition = sortedIndices.findIndex(idx => {
                                const lesson = this.lessons[idx];
                                return lesson.id && lesson.id.startsWith(prefix);
                            });
                        }
                    }

                    if (currentPosition !== -1 && currentPosition < sortedIndices.length - 1) {
                        // è·³è½¬åˆ°ä¸‹ä¸€ä¸ªè¯¾å·çš„è¯¾æ–‡
                        this.currentLessonIndex = sortedIndices[currentPosition + 1];
                        this.render();
                    } else {
                        this.showComplete();
                    }
                });
            }

            updateProgress() {
                const lesson = this.lessons[this.currentLessonIndex];
                let displayTitle = lesson.title;

                // å¦‚æœæ˜¯å¤šéƒ¨åˆ†è¯¾æ–‡ï¼Œæ˜¾ç¤ºç»Ÿä¸€æ ‡é¢˜ï¼ˆå»æ‰"- éƒ¨åˆ†å"ï¼‰
                if (lesson.id && lesson.id.includes('_')) {
                    displayTitle = lesson.title.split('- ')[0]; // æå–ä¸»æ ‡é¢˜
                }

                document.getElementById('progressText').textContent = displayTitle;
            }

            resetParagraph(paragraphIndex) {
                // æ‰¾åˆ°è¯¥æ®µè½å¯¹åº”çš„æ‰€æœ‰ç©ºæ ¼
                const blanks = this.container.querySelectorAll(`.paragraph-blank[data-paragraph-index="${paragraphIndex}"]`);
                const options = this.container.querySelectorAll('.option-tag');

                blanks.forEach(blank => {
                    if (blank.classList.contains('filled')) {
                        const filledValue = blank.dataset.selected;

                        // æ¢å¤é€‰é¡¹æ± ä¸­å¯¹åº”çš„é€‰é¡¹
                        options.forEach(opt => {
                            if (opt.dataset.value === filledValue && opt.classList.contains('used')) {
                                opt.classList.remove('used');
                            }
                        });

                        // æ¸…ç©ºç©ºæ ¼
                        blank.textContent = '';
                        blank.classList.remove('filled', 'correct', 'wrong');
                        delete blank.dataset.selected;
                    }
                });

                this.showToast('å·²é‡ç½®è¯¥æ®µè½');
            }

            resetPoem(poemIndex) {
                // æ‰¾åˆ°è¯¥å¤è¯—section
                const poemSection = this.container.querySelector(`.poem-section[data-poem-index="${poemIndex}"]`);
                if (!poemSection) return;

                // æ‰¾åˆ°è¯¥å¤è¯—å¯¹åº”çš„æ‰€æœ‰ç©ºæ ¼å’Œé€‰é¡¹
                const blanks = poemSection.querySelectorAll(`.paragraph-blank[data-poem-index="${poemIndex}"]`);
                const options = poemSection.querySelectorAll('.option-tag');

                blanks.forEach(blank => {
                    if (blank.classList.contains('filled')) {
                        const filledValue = blank.dataset.selected;

                        // æ¢å¤é€‰é¡¹æ± ä¸­å¯¹åº”çš„é€‰é¡¹
                        options.forEach(opt => {
                            if (opt.dataset.value === filledValue && opt.classList.contains('used')) {
                                opt.classList.remove('used');
                            }
                        });

                        // æ¸…ç©ºç©ºæ ¼
                        blank.textContent = '';
                        blank.classList.remove('filled', 'correct', 'wrong');
                        delete blank.dataset.selected;
                    }
                });

                this.showToast('å·²é‡ç½®è¯¥å¤è¯—');
            }

            checkAnswers() {
                const blanks = this.container.querySelectorAll('.paragraph-blank');
                let correct = 0;

                blanks.forEach(blank => {
                    const selected = blank.dataset.selected;
                    const answer = blank.dataset.answer;

                    if (!selected) {
                        blank.textContent = answer;
                        blank.classList.add('wrong');
                    } else if (selected === answer) {
                        blank.classList.add('correct');
                        correct++;
                    } else {
                        blank.classList.add('wrong');
                        // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                        setTimeout(() => {
                            blank.textContent = answer;
                        }, 500);
                    }
                });

                this.correctCount += correct;

                if (correct === blanks.length) {
                    this.showCorrectFeedback();
                    // è®°å½•ç­”å¯¹çš„è¯¾æ–‡
                    const lesson = this.lessons[this.currentLessonIndex];
                    window.storage.markQuestionCorrect(this.moduleId, lesson.id);
                    this.showToast('ğŸ‰ å…¨éƒ¨æ­£ç¡®ï¼');
                } else {
                    this.showToast(`æ­£ç¡® ${correct}/${blanks.length}`);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const quiz = new ParagraphFillQuiz({
                moduleId: 'course-knowledge'  // åŒ¹é…main.jsä¸­çš„MODULE_TOTAL_QUESTIONSé…ç½®
            });
            quiz.init();
        });
    </script>
</body>

</html>