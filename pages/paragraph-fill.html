<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ®µè½é€‰æ‹©å¡«ç©º - ä¸‰å¹´çº§è¯­æ–‡å¤ä¹ </title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        .lesson-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            max-height: 100px;
            overflow-y: auto;
            padding: 0.5rem;
            background: var(--bg-color);
            border-radius: var(--radius-lg);
        }

        .lesson-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
        }

        .lesson-btn:hover,
        .lesson-btn.active {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }

        .paragraph-area {
            padding: 1.5rem;
            background: var(--bg-color);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            line-height: 2;
            color: var(--text-primary);
        }

        .paragraph-blank {
            display: inline-block;
            min-width: 80px;
            padding: 0.2rem 0.5rem;
            border-bottom: 2px dashed var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .paragraph-blank:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .paragraph-blank.filled {
            background: var(--primary-color);
            color: white;
            border-radius: var(--radius-sm);
            border-bottom: none;
        }

        .paragraph-blank.correct {
            background: var(--success-color);
        }

        .paragraph-blank.wrong {
            background: var(--error-color);
        }

        .options-pool {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            padding: 1rem;
            margin-top: 1.5rem;
            background: var(--card-bg);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
        }

        .option-tag {
            padding: 0.4rem 0.8rem;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 0.875rem;
        }

        .option-tag:hover {
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .option-tag.selected {
            border-color: var(--primary-color);
            background: var(--primary-light);
            color: white;
        }

        .option-tag.used {
            opacity: 0.4;
            pointer-events: none;
        }

        .hint-text {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 1rem;
        }

        .paragraph-item {
            margin-bottom: 1.5rem;
        }

        .paragraph-item:last-child {
            margin-bottom: 0;
        }
    </style>
</head>

<body>
    <div class="quiz-container">
        <header class="quiz-header">
            <div class="quiz-back-btn" id="backBtn">
                <span>â†</span>
                <span>è¿”å›</span>
            </div>
            <h1 class="quiz-title">è¯¾æ–‡çŸ¥è¯†ç‚¹å¡«ç©º</h1>
            <div class="quiz-progress" id="progressText"></div>
        </header>

        <div class="quiz-content" id="quizContent">
            <div class="loading">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <div class="nav-buttons">
            <button class="btn btn-outline" id="resetBtn">ğŸ”„ é‡ç½®</button>
            <button class="btn btn-primary" id="checkBtn">âœ“ æ£€æŸ¥ç­”æ¡ˆ</button>
            <button class="btn btn-outline" id="nextBtn">ä¸‹ä¸€è¯¾ â†’</button>
        </div>
    </div>

    <script src="../js/utils/tts.js"></script>
    <script src="../js/utils/storage.js"></script>
    <script src="../js/quiz-types/QuizBase.js"></script>
    <script>
        class ParagraphFillQuiz extends QuizBase {
            constructor(options) {
                super(options);
                this.lessons = [];
                this.selectedOptions = {}; // è®°å½•æ¯ä¸ªç©ºæ ¼é€‰ä¸­çš„é€‰é¡¹
                this.currentLessonIndex = 0; // å½“å‰è¯¾
            }

            async loadData() {
                const data = await this.fetchJson('../data/course_knowledge.json');
                this.lessons = data.lessons;
                this.questions = this.lessons;
            }

            render() {
                const lesson = this.lessons[this.currentLessonIndex];
                this.selectedOptions = {}; // é‡ç½®é€‰é¡¹

                // æ”¶é›†è¯¥è¯¾æ‰€æœ‰æ®µè½çš„blanksï¼Œç”¨äºç”Ÿæˆé€‰é¡¹æ± 
                const allBlanks = [];
                lesson.paragraphs.forEach(p => {
                    allBlanks.push(...p.blanks);
                });

                // ç”Ÿæˆé€‰é¡¹æ± ï¼ˆåŒ…å«æ‰€æœ‰ç­”æ¡ˆå’Œä¸€äº›å¹²æ‰°é¡¹ï¼‰
                const distractors = this.generateDistractors(allBlanks);
                const allOptions = this.shuffle([...allBlanks, ...distractors]);

                // ç”Ÿæˆæ‰€æœ‰æ®µè½çš„HTML
                const paragraphsHtml = lesson.paragraphs.map((paragraph, pIndex) => {
                    let text = paragraph.text;
                    let blankIndex = 0;

                    // æ›¿æ¢æ‹¬å·å†…å®¹ä¸ºç©ºæ ¼
                    const displayText = text.replace(/ï¼ˆ[^ï¼‰]+ï¼‰/g, (match) => {
                        const answer = match.slice(1, -1);
                        const uniqueId = `p${pIndex}_b${blankIndex}`;
                        const html = `<span class="paragraph-blank" data-id="${uniqueId}" data-answer="${answer}">____</span>`;
                        blankIndex++;
                        return html;
                    });

                    return `
                        <div class="paragraph-item">
                            <div class="paragraph-area">
                                ${displayText}
                            </div>
                        </div>
                    `;
                }).join('');

                let html = `
                    <div class="lesson-selector">
                        ${this.lessons.map((l, i) => `
                            <button class="lesson-btn ${i === this.currentLessonIndex ? 'active' : ''}" data-index="${i}">${l.title.slice(0, 15)}</button>
                        `).join('')}
                    </div>

                    <div class="paragraphs-container">
                        ${paragraphsHtml}
                    </div>

                    <div class="options-pool">
                        ${allOptions.map(opt => `
                            <div class="option-tag" data-value="${opt}">${opt}</div>
                        `).join('')}
                    </div>

                    <p class="hint-text">å…ˆç‚¹å‡»é€‰é¡¹ï¼Œå†ç‚¹å‡»ç©ºæ ¼å¡«å…¥</p>
                `;

                this.container.innerHTML = html;
                this.bindEvents();
                this.updateProgress();
            }

            generateDistractors(blanks) {
                // ä»å…¶ä»–è¯¾æ–‡è·å–å¹²æ‰°é€‰é¡¹
                const allBlanks = [];
                this.lessons.forEach(l => {
                    l.paragraphs.forEach(p => {
                        allBlanks.push(...p.blanks);
                    });
                });

                const unique = [...new Set(allBlanks)].filter(b => !blanks.includes(b));
                return this.shuffle(unique).slice(0, Math.min(3, blanks.length));
            }

            bindEvents() {
                const options = this.container.querySelectorAll('.option-tag');
                const blanks = this.container.querySelectorAll('.paragraph-blank');

                options.forEach(opt => {
                    opt.addEventListener('click', () => {
                        if (opt.classList.contains('used')) return;
                        options.forEach(o => o.classList.remove('selected'));
                        opt.classList.add('selected');
                        this.selectedOption = opt;
                    });
                });

                blanks.forEach(blank => {
                    blank.addEventListener('click', () => {
                        if (blank.classList.contains('filled')) return;
                        if (!this.selectedOption) {
                            this.showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç­”æ¡ˆ');
                            return;
                        }

                        const value = this.selectedOption.dataset.value;
                        blank.textContent = value;
                        blank.classList.add('filled');
                        blank.dataset.selected = value;

                        this.selectedOption.classList.add('used');
                        this.selectedOption.classList.remove('selected');
                        this.selectedOption = null;
                    });
                });

                // è¯¾æ–‡åˆ‡æ¢
                const lessonBtns = this.container.querySelectorAll('.lesson-btn');
                lessonBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.currentLessonIndex = parseInt(btn.dataset.index);
                        this.render();
                    });
                });

                document.getElementById('backBtn').addEventListener('click', () => this.goBack());
                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.render();
                });
                document.getElementById('checkBtn').addEventListener('click', () => this.checkAnswers());
                document.getElementById('nextBtn').addEventListener('click', () => {
                    if (this.currentLessonIndex < this.lessons.length - 1) {
                        this.currentLessonIndex++;
                        this.render();
                    } else {
                        this.showComplete();
                    }
                });
            }

            updateProgress() {
                const lesson = this.lessons[this.currentLessonIndex];
                document.getElementById('progressText').textContent = lesson.title;
            }

            checkAnswers() {
                const blanks = this.container.querySelectorAll('.paragraph-blank');
                let correct = 0;

                blanks.forEach(blank => {
                    const selected = blank.dataset.selected;
                    const answer = blank.dataset.answer;

                    if (!selected) {
                        blank.textContent = answer;
                        blank.classList.add('wrong');
                    } else if (selected === answer) {
                        blank.classList.add('correct');
                        correct++;
                    } else {
                        blank.classList.add('wrong');
                        // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                        setTimeout(() => {
                            blank.textContent = answer;
                        }, 500);
                    }
                });

                this.correctCount += correct;

                if (correct === blanks.length) {
                    this.showCorrectFeedback();
                    this.showToast('ğŸ‰ å…¨éƒ¨æ­£ç¡®ï¼');
                } else {
                    this.showToast(`æ­£ç¡® ${correct}/${blanks.length}`);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const quiz = new ParagraphFillQuiz({
                moduleId: 'paragraph-fill'
            });
            quiz.init();
        });
    </script>
</body>

</html>